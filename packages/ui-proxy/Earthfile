VERSION 0.7

ARG --global --required DOCKER_REGISTRY_GROUP
ARG --global --required NPM_REGISTRY_GROUP
ARG --global --required NPM_REGISTRY_RELEASES
ARG --global --required NPM_REGISTRY_SNAPSHOTS
ARG --global --required NEXUS_REPOSITORY_URL

deps:
    ARG --required BASE_IMAGES_VERSION
    FROM ${DOCKER_REGISTRY_GROUP}/genestack-builder:${BASE_IMAGES_VERSION}

    COPY package.json package-lock.json ./
    RUN \
        --secret NEXUS_USER \
        --secret NEXUS_PASSWORD \
            npm-login.sh && \
            npm install

    SAVE IMAGE --cache-hint

build:
    FROM +deps

    COPY . .
    # Nothing to build and test
    #RUN \
    #    npm run test

    SAVE IMAGE --cache-hint

main:
    FROM +build

    RUN --push \
        --secret NEXUS_USER \
        --secret NEXUS_PASSWORD \
            npm-login.sh && \
            npm publish
